<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Retirement Calculator</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        html, body { height: 100%; margin: 0; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #fbc2eb 0%, #6dd5ed 100%);
        }
        h1 { text-align: center; margin: 32px 0 10px 0; color: #1a2980; }
        .caption {
            text-align: center;
            margin-top: -8px;
            margin-bottom: 24px;
            color: #1a298099;
            font-weight: 500;
        }
        .navbar {
            background: linear-gradient(90deg,#1a2980,#26d0ce);
            display: flex; flex-wrap: wrap; justify-content: center; align-items: center;
            padding: 16px 0 10px 0;
            box-shadow: 0 2px 8px #0001;
            position: sticky; top: 0; z-index: 5;
        }
        .navbtn {
            padding: 10px 26px; margin: 5px 8px;
            background: #fff; color: #1a2980; border: none; border-radius: 24px;
            font-size: 1.09em; font-weight: 600;
            display: flex; align-items: center; gap: 8px;
            transition: background 0.2s, color 0.2s;
            box-shadow: 0 2px 8px #1a298008;
            cursor: pointer;
        }
        .navbtn.active, .navbtn:hover {
            background: #26d0ce; color: #fff;
        }
        .hidden { display: none; }
        .main-card {
            background: #fff;
            border-radius: 22px;
            padding: 36px 28px 28px 28px;
            margin: 32px auto 18px auto; max-width: 1150px;
            box-shadow: 0 8px 32px #1a298022;
        }
        .calculator-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0 38px;
            margin-bottom: 22px;
        }
        .column-block {
            background: linear-gradient(135deg, #e3fdfd 0%, #fff 100%);
            border-radius: 18px;
            padding: 22px 18px 18px 18px;
            box-shadow: 0 2px 24px #1a298008;
            margin-bottom: 10px;
        }
        .column-block h3 {
            margin: 0 0 14px 0;
            font-size: 1.09em;
            color: #26d0ce;
            text-align: left;
            font-weight: 700;
            letter-spacing: 0.5px;
        }
        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 3px; font-weight: 600; color: #2d3748; }
        input[type="number"], input[type="text"], select {
            width: 100%; padding: 8px 10px; border-radius: 8px;
            border: 1.5px solid #e2e8f0; font-size: 1em; background: #f1f5f9;
            transition: border 0.2s;
            box-sizing: border-box;
        }
        input[type="number"]:focus, input[type="text"]:focus, select:focus {
            border: 2px solid #26d0ce;
            outline: none;
            background: #e3fdfd;
        }
        .btn, .btn-secondary {
            padding: 13px 28px; background: linear-gradient(90deg,#1a2980,#26d0ce); color: #fff;
            border: none; border-radius: 16px; font-size: 1.07em; font-weight: 600;
            margin: 10px 8px 18px 0; cursor: pointer; box-shadow: 0 2px 8px #1a298022;
            transition: background 0.2s, box-shadow 0.2s;
            display: inline-block;
        }
        .btn-secondary {
            background: linear-gradient(90deg,#36c1ee,#fbc2eb);
            color: #1a2980;
        }
        .btn:disabled, .btn-secondary:disabled { background: #aac7ee; color: #fff;}
        .results-block { background: #fafaff; border-radius: 16px; box-shadow: 0 2px 16px #26d0ce18; padding: 18px; margin-top: 24px;}
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 25px;
            margin-bottom: 25px;
        }
        .chart-container { background: #fff; padding: 10px; border-radius: 8px; box-shadow: 0 2px 8px #0001; }
        .toggle-btn {
            font-size: 0.7em;
            padding: 4px 10px;
            margin-left: 15px;
            vertical-align: middle;
            cursor: pointer;
            border-radius: 12px;
            border: 1px solid #ccc;
            background: #f0f0f0;
            transition: background .2s, color .2s;
        }
        .toggle-btn:hover { background: #e0e0e0; }
        .recommendations-block {
            margin-top: 25px;
            padding: 20px;
            background: #fff9e6;
            border: 1px solid #ffecb3;
            border-radius: 12px;
        }
        .recommendations-block h3 { color: #856404; }
        .recommendations-block ul { padding-left: 20px; }
        .recommendations-block li { margin-bottom: 10px; }

        .compare-section { background: #fff; border-radius:14px; margin-top:22px; padding: 20px; box-shadow:0 2px 10px #26d0ce18;}
        .compare-table { margin-top:10px;}
        .compare-table .best-in-class { background-color: #d4edda; font-weight: 600; }
        
        .saved { color: #28a745; font-weight: 600; margin-top: 10px; }
        .expense-table { width: 100%; border-collapse: collapse; margin-top: 10px;}
        th, td { border: none; padding: 8px 10px; font-size: 1em; text-align: right; }
        th { background: #eaf6ff; color: #1a2980; font-weight: 600; }
        .expense-table td:first-child, .expense-table th:first-child { text-align: left;}
        .expense-table tbody tr:nth-child(even) { background: #f6f9fc; }
        .expense-table tbody tr:nth-child(odd) { background: #fbc2eb33; }
        .expense-icon { font-size: 1.2em; color: #36c1ee; margin-right: 9px;}
        #customSplitInputs, #rothConversionInput { margin-top: 12px; }
        #customSplitInputs label, #rothConversionInput label { margin-bottom: 0; }
        .tax-note { background: #fff3cd; border: 1px solid #ffeaa7; padding: 10px; border-radius: 8px; margin: 10px 0; font-size: 0.9em; }
        
        /* Tooltip Styles */
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            color: #6c757d;
        }
        .navbtn .tooltip { color: inherit; }
        .tooltip .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 10;
            bottom: 150%;
            left: 50%;
            margin-left: -110px;
            opacity: 0;
            transition: opacity 0.3s;
            font-weight: 400;
            font-size: 0.9em;
        }
        .tooltip .tooltip-text.tooltip-wide {
            width: 300px;
            margin-left: -150px;
            text-align: left;
        }
        .tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        @media (max-width: 1100px) {
            .main-card { padding: 18px 2vw 18px 2vw; max-width: 99vw; }
            .calculator-grid { grid-template-columns: repeat(2, 1fr); gap: 0 22px;}
            .column-block { margin-bottom: 18px;}
            .chart-grid { grid-template-columns: 1fr; }
        }
        @media (max-width: 700px) {
            .calculator-grid { grid-template-columns: 1fr; gap: 0 0;}
            .main-card { padding: 8px 1vw; }
            .btn, .btn-secondary { font-size: 1em; padding: 8px 16px;}
        }
    </style>
</head>
<body>
    <h1><i class="fa-solid fa-person-cane"></i> Retirement Calculator</h1>
    <p class="caption">Find out when you can retire and how long your money will last.</p>

    <div class="navbar">
        <button class="navbtn active" id="nav-calculator-us" onclick="showPage('calculator-us')">
            <i class="fa-solid fa-dollar-sign"></i> Retire in US
            <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Run a detailed, year-by-year retirement projection based on US tax rules.</span></span>
        </button>
        <button class="navbtn" id="nav-expenses-us" onclick="showPage('expenses-us')">
            <i class="fa-solid fa-car"></i> US Expenses
            <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Detailed expense tracker to calculate your monthly budget in the US.</span></span>
        </button>
        <button class="navbtn" id="nav-calculator-india" onclick="showPage('calculator-india')">
            <i class="fa-solid fa-indian-rupee-sign"></i> Retire in India
            <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Run a detailed, year-by-year retirement projection based on Indian tax rules.</span></span>
        </button>
        <button class="navbtn" id="nav-expenses-india" onclick="showPage('expenses-india')">
            <i class="fa-solid fa-motorcycle"></i> India Expenses
            <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Detailed expense tracker to calculate your monthly budget in India.</span></span>
        </button>
    </div>

    <div id="page-calculator-us" class="main-card">
        <div class="tax-note">
            <strong>ðŸ“‹ Tax Logic:</strong> Taxes calculated on: Retirement Income + Pre-tax Withdrawals + Investment Gains on Post-tax Money + Roth Conversions. 
            Roth withdrawals and return of post-tax principal are tax-free.
        </div>
        <form id="form-calculator-us" autocomplete="off">
            <div class="calculator-grid">
                <div class="column-block">
                    <h3><i class="fa-solid fa-calendar-check"></i> Retirement Need</h3>
                    <div class="input-group">
                        <label>Retirement Age <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The age you plan to stop working.</span></span></label>
                        <input type="number" name="retirementAge" min="0" required>
                    </div>
                    <div class="input-group">
                        <label>Years in Retirement <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">How many years you expect your retirement to last.</span></span></label>
                        <input type="number" name="retirementYears" min="0" required>
                    </div>
                    <div class="input-group">
                        <label>Desired Final Balance ($) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The amount of money you want left over at the end of your retirement.</span></span></label>
                        <input type="number" name="finalBalance" value="0" min="0" required>
                    </div>
                </div>
                <div class="column-block">
                    <h3><i class="fa-solid fa-money-bill-wave"></i> Expenses</h3>
                    <div class="input-group">
                        <label>Monthly Expenses ($) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Your estimated essential monthly spending in retirement (in today's money).</span></span></label>
                        <input type="number" name="monthlyExpenses" id="monthlyExpensesInputUS" min="0" required>
                        <div style="font-size:0.96em;color:#888;margin-top:2px;">
                            <span id="us-expenses-link" style="cursor:pointer;text-decoration:underline;color:#26d0ce;" onclick="useSavedExpenses('us', 'monthlyExpensesInputUS')">
                                <i class="fa-solid fa-car"></i> Use US Expenses
                            </span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Annual Travel Budget ($) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">An extra annual budget for travel or other large one-time expenses.</span></span></label>
                        <input type="number" name="travelExpense" value="0" min="0" required>
                    </div>
                </div>
                <div class="column-block">
                    <h3><i class="fa-solid fa-vault"></i> Assets/Income</h3>
                    <div class="input-group">
                        <label>Pre-tax ($) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Money in accounts like a 401(k) or Traditional IRA, which will be taxed upon withdrawal.</span></span></label>
                        <input type="number" name="preTaxMoney" min="0" required>
                    </div>
                    <div class="input-group">
                        <label>Post-tax ($) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Money in accounts like a Roth IRA or brokerage. Only the gains are taxed upon withdrawal.</span></span></label>
                        <input type="number" name="postTaxMoney" min="0" required>
                    </div>
                    <div class="input-group">
                        <label>Expected Retirement Income ($/yr) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Guaranteed annual income you'll receive, like a pension or Social Security.</span></span></label>
                        <input type="number" name="retirementIncome" value="0" min="0" required>
                    </div>
                </div>
                <div class="column-block">
                    <h3><i class="fa-solid fa-cogs"></i> Misc</h3>
                    <div class="input-group">
                        <label>Expected Investment Return (%) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The average annual return you expect from your investments.</span></span></label>
                        <input type="number" name="investmentReturn" min="0" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label>Inflation Rate (%) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The average annual rate at which the cost of living will increase.</span></span></label>
                        <input type="number" name="inflationRate" min="0" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label>Withdrawal Strategy <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text tooltip-wide"><strong>Proportional:</strong> Withdraws from accounts based on their current size ratio.<br><br><strong>Sequential:</strong> Spends all post-tax money first before touching pre-tax funds.<br><br><strong>Roth Conversion:</strong> Converts pre-tax money to post-tax (Roth) each year to manage future taxes.<br><br><strong>Custom % Split:</strong> You specify the exact percentage to pull from each account type.</span></span></label>
                        <select name="withdrawalStrategy" id="withdrawalStrategyUS" onchange="handleStrategyChange('us')">
                            <option value="proportional">Proportional</option>
                            <option value="sequential">Sequential (Post-tax first)</option>
                            <option value="roth">Roth Conversion Ladder</option>
                            <option value="custom">Custom % split</option>
                        </select>
                    </div>
                    <div class="input-group" id="customSplitInputsUS" style="display:none;">
                      <label>Withdraw from Pre-tax (%)</label><input type="number" name="customPreTaxPct" min="0" max="100" step="1">
                    </div>
                    <div class="input-group" id="rothConversionInputUS" style="display:none;">
                      <label>Roth Conversion Amount per Year ($)</label>
                      <input type="number" name="rothConversionAmt" min="0">
                    </div>
                </div>
            </div>
            <button type="button" class="btn" onclick="calculateRetirement('us')"><i class="fa-solid fa-chart-line"></i> Calculate</button>
            <button type="button" class="btn-secondary" onclick="openCompare('us')"><i class="fa-solid fa-chart-bar"></i> Compare Strategies</button>
            <button type="button" class="btn-secondary" onclick="exportTable('us','csv')"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
            <button type="button" class="btn-secondary" onclick="exportTable('us','xlsx')"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
            <button type="button" class="btn-secondary" onclick="clearInputs('us')"><i class="fa-solid fa-eraser"></i> Clear Data</button>
        </form>
        <div id="results-block-us" class="results-block"></div>
        <div id="compare-block-us" class="compare-section hidden"></div>
    </div>

    <div id="page-calculator-india" class="main-card hidden">
        <div class="tax-note">
            <strong>ðŸ“‹ Tax Logic:</strong> Taxes calculated on: Retirement Income + Pre-tax Withdrawals + Investment Gains on Post-tax Money + Roth Conversions. 
            Roth withdrawals and return of post-tax principal are tax-free. India tax model includes a 4% cess.
        </div>
        <form id="form-calculator-india" autocomplete="off">
            <div class="calculator-grid">
                 <div class="column-block">
                    <h3><i class="fa-solid fa-calendar-check"></i> Retirement Need</h3>
                    <div class="input-group">
                        <label>Retirement Age <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The age you plan to stop working.</span></span></label>
                        <input type="number" name="retirementAge" min="0" required>
                    </div>
                    <div class="input-group">
                        <label>Years in Retirement <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">How many years you expect your retirement to last.</span></span></label>
                        <input type="number" name="retirementYears" min="0" required>
                    </div>
                    <div class="input-group">
                        <label>Desired Final Balance (â‚¹) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The amount of money you want left over at the end of your retirement.</span></span></label>
                        <input type="number" name="finalBalance" value="0" min="0" required>
                    </div>
                </div>
                <div class="column-block">
                    <h3><i class="fa-solid fa-money-bill-wave"></i> Expenses</h3>
                    <div class="input-group">
                        <label>Monthly Expenses (â‚¹) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Your estimated essential monthly spending in retirement (in today's money).</span></span></label>
                        <input type="number" name="monthlyExpenses" id="monthlyExpensesInputIndia" min="0" required>
                        <div style="font-size:0.96em;color:#888;margin-top:2px;">
                            <span id="india-expenses-link" style="cursor:pointer;text-decoration:underline;color:#26d0ce;" onclick="useSavedExpenses('india', 'monthlyExpensesInputIndia')">
                                <i class="fa-solid fa-motorcycle"></i> Use India Expenses
                            </span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Annual Travel Budget (â‚¹) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">An extra annual budget for travel or other large one-time expenses.</span></span></label>
                        <input type="number" name="travelExpense" value="0" min="0" required>
                    </div>
                </div>
                <div class="column-block">
                    <h3><i class="fa-solid fa-vault"></i> Assets/Income</h3>
                    <div class="input-group">
                        <label>Pre-tax (â‚¹) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Money in accounts like EPF or NPS, which will be taxed upon withdrawal.</span></span></label>
                        <input type="number" name="preTaxMoney" min="0" required>
                    </div>
                    <div class="input-group">
                        <label>Post-tax (â‚¹) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Money in accounts like mutual funds or stocks. Only the gains are taxed upon withdrawal.</span></span></label>
                        <input type="number" name="postTaxMoney" min="0" required>
                    </div>
                    <div class="input-group">
                        <label>Expected Retirement Income (â‚¹/yr) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">Guaranteed annual income you'll receive, like a pension or rental income.</span></span></label>
                        <input type="number" name="retirementIncome" value="0" min="0" required>
                    </div>
                </div>
                <div class="column-block">
                    <h3><i class="fa-solid fa-cogs"></i> Misc</h3>
                    <div class="input-group">
                        <label>Expected Investment Return (%) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The average annual return you expect from your investments.</span></span></label>
                        <input type="number" name="investmentReturn" min="0" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label>Inflation Rate (%) <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text">The average annual rate at which the cost of living will increase.</span></span></label>
                        <input type="number" name="inflationRate" min="0" step="0.01" required>
                    </div>
                    <div class="input-group">
                        <label>Withdrawal Strategy <span class="tooltip"><i class="fa-solid fa-circle-info"></i><span class="tooltip-text tooltip-wide"><strong>Proportional:</strong> Withdraws from accounts based on their current size ratio.<br><br><strong>Sequential:</strong> Spends all post-tax money first before touching pre-tax funds.<br><br><strong>Roth Conversion:</strong> Converts pre-tax money to post-tax (Roth) each year to manage future taxes.<br><br><strong>Custom % Split:</strong> You specify the exact percentage to pull from each account type.</span></span></label>
                        <select name="withdrawalStrategy" id="withdrawalStrategyIndia" onchange="handleStrategyChange('india')">
                            <option value="proportional">Proportional</option>
                            <option value="sequential">Sequential (Post-tax first)</option>
                            <option value="roth">Roth Conversion Ladder</option>
                            <option value="custom">Custom % split</option>
                        </select>
                    </div>
                    <div class="input-group" id="customSplitInputsIndia" style="display:none;">
                      <label>Withdraw from Pre-tax (%)</label><input type="number" name="customPreTaxPct" min="0" max="100" step="1">
                    </div>
                    <div class="input-group" id="rothConversionInputIndia" style="display:none;">
                      <label>Roth Conversion Amount per Year (â‚¹)</label>
                      <input type="number" name="rothConversionAmt" min="0">
                    </div>
                </div>
            </div>
            <button type="button" class="btn" onclick="calculateRetirement('india')"><i class="fa-solid fa-chart-line"></i> Calculate</button>
            <button type="button" class="btn-secondary" onclick="openCompare('india')"><i class="fa-solid fa-chart-bar"></i> Compare Strategies</button>
            <button type="button" class="btn-secondary" onclick="exportTable('india','csv')"><i class="fa-solid fa-file-csv"></i> Export CSV</button>
            <button type="button" class="btn-secondary" onclick="exportTable('india','xlsx')"><i class="fa-solid fa-file-excel"></i> Export Excel</button>
            <button type="button" class="btn-secondary" onclick="clearInputs('india')"><i class="fa-solid fa-eraser"></i> Clear Data</button>
        </form>
        <div id="results-block-india" class="results-block"></div>
        <div id="compare-block-india" class="compare-section hidden"></div>
    </div>

    <div id="page-expenses-us" class="main-card hidden">
        <h2><i class="fa-solid fa-car-side"></i> Enter Monthly Expenses (US)</h2>
        <form id="form-expenses-us">
            <table class="expense-table" id="monthly-expenses-us">
                <thead>
                    <tr><th>Category</th><th>Monthly ($)</th><th>Yearly ($)</th></tr>
                </thead>
                <tbody>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">HOUSING</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-house"></span>Rent / Mortgage</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-file-invoice-dollar"></span>Property Tax</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-house-shield"></span>Home Insurance</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-users"></span>HOA Dues</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-toolbox"></span>Repairs & Maintenance</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">UTILITIES</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-lightbulb"></span>Electricity</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-fire-flame-simple"></span>Gas & Water</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-mobile-screen-button"></span>Mobile Phone</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-wifi"></span>Internet & Cable</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">TRANSPORTATION</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-car-side"></span>Car Payment</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-shield-halved"></span>Car Insurance</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-gas-pump"></span>Fuel / Gas</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-wrench"></span>Car Maintenance</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-bus"></span>Public Transit / Rideshare</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">FOOD</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-cart-shopping"></span>Groceries</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-utensils"></span>Restaurants & Dining Out</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">HEALTH</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-heart-pulse"></span>Health Insurance Premium</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-pills"></span>Medical (Co-pays, Prescriptions)</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">PERSONAL & FAMILY</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-shirt"></span>Shopping & Clothing</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-spa"></span>Personal Care (Hair, etc.)</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-dumbbell"></span>Gym & Fitness</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-graduation-cap"></span>Education</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-paw"></span>Pet Expenses</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">LEISURE & FINANCIAL</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-film"></span>Hobbies & Entertainment</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-plane"></span>Vacations</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-credit-card"></span>Debt Payments (Loans, CC)</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-hand-holding-heart"></span>Donations & Gifts</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-ellipsis"></span>Miscellaneous</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                </tbody>
                <tfoot>
                    <tr><th>Total</th><th id="us-total-monthly"></th><th id="us-total-yearly"></th></tr>
                </tfoot>
            </table>
            <button type="button" class="btn" onclick="saveExpenses('us')"><i class="fa-solid fa-save"></i> Save US Expenses</button>
        </form>
        <div id="us-expenses-saved" class="saved"></div>
    </div>

    <div id="page-expenses-india" class="main-card hidden">
        <h2><i class="fa-solid fa-motorcycle"></i> Enter Monthly Expenses (India)</h2>
        <form id="form-expenses-india">
            <table class="expense-table" id="monthly-expenses-india">
                <thead>
                    <tr><th>Category</th><th>Monthly (â‚¹)</th><th>Yearly (â‚¹)</th></tr>
                </thead>
                <tbody>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">HOUSING</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-house"></span>Rent / EMI</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-users"></span>Maintenance Charges</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-file-invoice-dollar"></span>Municipal Tax</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-toolbox"></span>Repairs & Upkeep</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">UTILITIES</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-lightbulb"></span>Electricity Bill</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-fire-burner"></span>Cooking Gas (LPG)</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-droplet"></span>Water Bill</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-mobile-screen-button"></span>Mobile & DTH Recharge</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-wifi"></span>Internet</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">TRANSPORTATION</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-gas-pump"></span>Vehicle Fuel (Car/Two-Wheeler)</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-shield-halved"></span>Vehicle Insurance & Maint.</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-train-subway"></span>Public Transport</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">FOOD & HOUSEHOLD</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-cart-shopping"></span>Groceries</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-utensils"></span>Restaurants & Online Orders</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-hand-sparkles"></span>Domestic Help (Maid, Cook)</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">HEALTH</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-heart-pulse"></span>Health Insurance Premium</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-pills"></span>Out-of-pocket Medical</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">PERSONAL & FAMILY</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-shirt"></span>Shopping & Clothing</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-spa"></span>Personal Care</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-graduation-cap"></span>Children's Education</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><th colspan="3" style="text-align: left; background-color: #e3fdfd;">LEISURE & FINANCIAL</th></tr>
                    <tr><td><span class="expense-icon fa-solid fa-film"></span>Hobbies & Entertainment</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-plane"></span>Vacations & Travel</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-credit-card"></span>Loan Repayments (EMI)</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-piggy-bank"></span>Investments & SIPs</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-hand-holding-heart"></span>Donations & Gifts</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-gopuram"></span>Festivals & Functions</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                    <tr><td><span class="expense-icon fa-solid fa-ellipsis"></span>Miscellaneous</td><td><input type="number" min="0" value="0"></td><td class="yearly"></td></tr>
                </tbody>
                <tfoot>
                    <tr><th>Total</th><th id="india-total-monthly"></th><th id="india-total-yearly"></th></tr>
                </tfoot>
            </table>
            <button type="button" class="btn" onclick="saveExpenses('india')"><i class="fa-solid fa-save"></i> Save India Expenses</button>
        </form>
        <div id="india-expenses-saved" class="saved"></div>
    </div>

<script>
/*
  Full retirement calculation logic with advanced graphing and recommendations.
*/

(function () {
  const PAGES = ['calculator-us', 'calculator-india', 'expenses-us', 'expenses-india'];
  window.myCharts = {};

  function $(sel, root = document) { return root.querySelector(sel); }
  function $all(sel, root = document) { return Array.from(root.querySelectorAll(sel)); }

  window.showPage = function (key) {
    PAGES.forEach(p => {
      const pageEl = document.getElementById(`page-${p}`);
      const navEl = document.getElementById(`nav-${p}`);
      if (pageEl) pageEl.classList.add('hidden');
      if (navEl) navEl.classList.remove('active');
    });
    const toShow = document.getElementById(`page-${key}`);
    const toActivate = document.getElementById(`nav-${key}`);
    if (toShow) toShow.classList.remove('hidden');
    if (toActivate) toActivate.classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
  };

  window.handleStrategyChange = function (region) {
    const strategy = $(`#withdrawalStrategy${region === 'us' ? 'US' : 'India'}`)?.value || 'proportional';
    $(`#customSplitInputs${region === 'us' ? 'US' : 'India'}`).style.display = strategy === 'custom' ? 'block' : 'none';
    $(`#rothConversionInput${region === 'us' ? 'US' : 'India'}`).style.display = strategy === 'roth' ? 'block' : 'none';
  };

  window.saveExpenses = function (region) {
    const table = $(`#monthly-expenses-${region}`);
    if (!table) return;
    const rows = $all('tbody tr', table)
      .filter(tr => tr.querySelector('input'))
      .map(tr => ({
        label: tr.cells?.[0]?.innerText?.trim() || '',
        monthly: parseFloat(tr.querySelector('input')?.value || '0') || 0
    }));
    localStorage.setItem(`rc:expenses:${region}`, JSON.stringify({ rows, updatedAt: Date.now() }));
    updateExpenseDerived(table, region);
    const savedEl = $(`#${region}-expenses-saved`);
    if (savedEl) {
      const monthlyTotal = rows.reduce((s, r) => s + r.monthly, 0);
      savedEl.textContent = `Saved! Total monthly expenses: ${fmtNum(monthlyTotal, region)}`;
    }
  };

  window.useSavedExpenses = function (region, targetInputId) {
    const raw = localStorage.getItem(`rc:expenses:${region}`);
    if (!raw) {
      alert(`No saved ${region.toUpperCase()} expenses found.`);
      return;
    }
    const data = JSON.parse(raw);
    const monthlyTotal = (data.rows || []).reduce((s, r) => s + (r.monthly || 0), 0);
    const input = document.getElementById(targetInputId);
    if (input) {
      input.value = String(Math.round(monthlyTotal));
      flash(input);
    }
  };
  
  function getInputs(region) {
      const form = $(`#form-calculator-${region}`);
      const formData = new FormData(form);
      return {
          retirementAge: num(formData.get('retirementAge')),
          retirementYears: num(formData.get('retirementYears')),
          monthlyExpenses: num(formData.get('monthlyExpenses')),
          travelExpense: num(formData.get('travelExpense')),
          preTaxMoney: num(formData.get('preTaxMoney')),
          postTaxMoney: num(formData.get('postTaxMoney')),
          retirementIncome: num(formData.get('retirementIncome')),
          investmentReturn: num(formData.get('investmentReturn')) / 100,
          inflationRate: num(formData.get('inflationRate')) / 100,
          withdrawalStrategy: formData.get('withdrawalStrategy'),
          customPreTaxPct: num(formData.get('customPreTaxPct')) / 100,
          rothConversionAmt: num(formData.get('rothConversionAmt')),
      };
  }
  
  function runSingleSimulation(inputs) {
    const results = [];
    let preTax = inputs.preTaxMoney;
    let postTax = inputs.postTaxMoney;
    let postTaxPrincipal = inputs.postTaxMoney;
    const endAge = inputs.retirementAge + inputs.retirementYears;

    for (let age = inputs.retirementAge; age < endAge; age++) {
        const startBalance = preTax + postTax;

        if (startBalance < 0 && results.length > 0) {
            preTax = 0; postTax = 0;
        }

        const gains = startBalance * inputs.investmentReturn;
        preTax *= (1 + inputs.investmentReturn);
        postTax *= (1 + inputs.investmentReturn);
        
        const yearsIntoRetirement = age - inputs.retirementAge;
        const annualExpenses = (inputs.monthlyExpenses * 12 + inputs.travelExpense) * Math.pow(1 + inputs.inflationRate, yearsIntoRetirement);
        
        let neededFromSavings = Math.max(0, annualExpenses - inputs.retirementIncome);
        let rothConversion = 0;
        
        if (inputs.withdrawalStrategy === 'roth') {
            const conversionAmt = inputs.rothConversionAmt > 0 ? inputs.rothConversionAmt : preTax * 0.05;
            rothConversion = Math.min(preTax, conversionAmt);
            preTax -= rothConversion;
            postTax += rothConversion;
            postTaxPrincipal += rothConversion;
        }

        let tempPreTaxW = 0, tempPostTaxW = 0;
        if (neededFromSavings > 0) {
            ({ preTaxW: tempPreTaxW, postTaxW: tempPostTaxW } = getWithdrawalSplit(neededFromSavings, preTax, postTax, inputs));
        }

        const postTaxGainsRatio = postTax > postTaxPrincipal ? (postTax - postTaxPrincipal) / postTax : 0;
        const taxablePostTaxWithdrawal = tempPostTaxW * postTaxGainsRatio;
        const taxableIncome = inputs.retirementIncome + tempPreTaxW + taxablePostTaxWithdrawal + rothConversion;
        const taxesPaid = calculateTaxes(taxableIncome, inputs.region);

        const withdrawal = Math.max(0, annualExpenses + taxesPaid - inputs.retirementIncome);
        
        let preTaxWithdrawal = 0, postTaxWithdrawal = 0;
        if (withdrawal > 0) {
            ({ preTaxW: preTaxWithdrawal, postTaxW: postTaxWithdrawal } = getWithdrawalSplit(withdrawal, preTax, postTax, inputs));
        }

        preTax -= preTaxWithdrawal;
        postTax -= postTaxWithdrawal;
        
        const postTaxWithdrawalPrincipal = postTaxWithdrawal * (1 - postTaxGainsRatio);
        postTaxPrincipal -= postTaxWithdrawalPrincipal;
        
        results.push({ 
            age, startBalance, annualExpenses, taxableIncome, gains, 
            withdrawal, taxesPaid, endBalance: preTax + postTax,
            preTaxBalance: preTax, postTaxBalance: postTax
        });
    }
    return results;
  }
  
  window.calculateRetirement = function (region) {
      let inputs = getInputs(region);
      inputs.region = region;
      const results = runSingleSimulation(inputs);
      renderResults(results, region, inputs);
      renderAllCharts(results, region);
      renderRecommendations(results, region);
  };

  function getWithdrawalSplit(amount, preTax, postTax, inputs) {
      let preTaxW = 0, postTaxW = 0;
      const customPct = inputs.customPreTaxPct > 0 ? inputs.customPreTaxPct : 0.5;

      switch (inputs.withdrawalStrategy) {
          case 'sequential': case 'roth':
              postTaxW = Math.min(postTax, amount);
              preTaxW = Math.min(preTax, amount - postTaxW);
              break;
          case 'custom':
              preTaxW = Math.min(preTax, amount * customPct);
              postTaxW = Math.min(postTax, amount * (1 - customPct));
              break;
          default:
              const total = preTax + postTax;
              if (total > 0) {
                  const preTaxRatio = preTax / total;
                  preTaxW = Math.min(preTax, amount * preTaxRatio);
                  postTaxW = Math.min(postTax, amount - preTaxW);
              }
      }
      return { preTaxW, postTaxW };
  }

  function calculateTaxes(income, region) {
      if (income <= 0) return 0;
      let tax = 0;
      if (region === 'us') {
          const brackets = [
              { rate: 0.35, over: 243725 }, { rate: 0.32, over: 191950 }, { rate: 0.24, over: 100525 },
              { rate: 0.22, over: 47150 }, { rate: 0.12, over: 11600 }, { rate: 0.10, over: 0 }
          ];
          let remainingIncome = income;
          for (const bracket of brackets) {
              if (remainingIncome > bracket.over) {
                  tax += (remainingIncome - bracket.over) * bracket.rate;
                  remainingIncome = bracket.over;
              }
          }
      } else {
          const brackets = [
              { rate: 0.30, over: 2400000 }, { rate: 0.25, over: 2000000 }, { rate: 0.20, over: 1600000 },
              { rate: 0.15, over: 1200000 }, { rate: 0.10, over: 800000 }, { rate: 0.05, over: 400000 }, { rate: 0.00, over: 0 }
          ];
          let remainingIncome = income;
          for (const bracket of brackets) {
              if (remainingIncome > bracket.over) {
                  tax += (remainingIncome - bracket.over) * bracket.rate;
                  remainingIncome = bracket.over;
              }
          }
          tax *= 1.04;
      }
      return tax;
  }
  
  function renderResults(results, region, inputs) {
      const resultsBlock = $(`#results-block-${region}`);
      
      let resultsHTML = `
      <div class="chart-grid">
        <div class="chart-container"><canvas id="chart1-${region}"></canvas></div>
        <div class="chart-container"><canvas id="chart2-${region}"></canvas></div>
        <div class="chart-container"><canvas id="chart3-${region}"></canvas></div>
        <div class="chart-container"><canvas id="chart4-${region}"></canvas></div>
      </div>
      
      <h3 style="margin-top:1rem;">
        Amortization Table
        <button id="toggleTableBtn-${region}" class="toggle-btn" title="Show/Hide Table">
            <i class="fa-solid fa-eye-slash"></i> Collapse
        </button>
      </h3>
      <table class="expense-table" id="amortization-table-${region}">
        <thead>
          <tr>
            <th>Age</th><th>Start Balance</th><th>Expenses</th><th>Total Income</th>
            <th>Withdrawal</th><th>Taxes Paid</th><th>Gains</th><th>End Balance</th>
          </tr>
        </thead><tbody>`;

      results.forEach(r => {
          resultsHTML += `
            <tr style="${r.endBalance < 0 ? 'color: red;' : ''}">
              <td>${r.age}</td><td>${fmtNum(r.startBalance, region)}</td>
              <td>${fmtNum(r.annualExpenses, region)}</td><td>${fmtNum(r.taxableIncome, region)}</td>
              <td>${fmtNum(r.withdrawal, region)}</td><td>${fmtNum(r.taxesPaid, region)}</td>
              <td style="color: ${r.gains >= 0 ? 'green' : 'red'};">${fmtNum(r.gains, region)}</td>
              <td style="font-weight:600;">${fmtNum(r.endBalance, region)}</td>
            </tr>`;
      });

      resultsHTML += `</tbody></table><div id="recommendations-block-${region}"></div>`;
      resultsBlock.innerHTML = resultsHTML;

      const toggleBtn = $(`#toggleTableBtn-${region}`);
      const table = $(`#amortization-table-${region}`);
      toggleBtn.addEventListener('click', () => {
          if (table.style.display === 'none') {
              table.style.display = '';
              toggleBtn.innerHTML = '<i class="fa-solid fa-eye-slash"></i> Collapse';
          } else {
              table.style.display = 'none';
              toggleBtn.innerHTML = '<i class="fa-solid fa-eye"></i> Expand';
          }
      });
  }

  function renderAllCharts(results, region) {
    const currency = region === 'us' ? '$' : 'â‚¹';
    const labels = results.map(r => r.age);
    
    Object.values(window.myCharts).forEach(chart => {
        if(chart) chart.destroy();
    });

    const chart1Ctx = $(`#chart1-${region}`).getContext('2d');
    window.myCharts.chart1 = new Chart(chart1Ctx, {
        type: 'line', data: { labels, datasets: [ { label: 'Total Income', data: results.map(r => r.taxableIncome), borderColor: 'rgb(54, 162, 235)' }, { label: 'Annual Expenses', data: results.map(r => r.annualExpenses), borderColor: 'rgb(255, 99, 132)' } ] },
        options: { plugins: { title: { display: true, text: 'Income vs. Expenses' } }, scales: { x: { title: { display: true, text: 'Age' } } } }
    });

    const chart2Ctx = $(`#chart2-${region}`).getContext('2d');
    window.myCharts.chart2 = new Chart(chart2Ctx, {
        type: 'bar', data: { labels, datasets: [ { label: 'Annual Expenses', data: results.map(r => r.annualExpenses), backgroundColor: 'rgba(75, 192, 192, 0.5)' }, { label: 'Taxes Paid', data: results.map(r => r.taxesPaid), backgroundColor: 'rgba(255, 99, 132, 0.5)' } ] },
        options: { plugins: { title: { display: true, text: 'Uses of Funds (Withdrawal Breakdown)' } }, scales: { x: { stacked: true, title: { display: true, text: 'Age' } }, y: { stacked: true } } }
    });

    const chart3Ctx = $(`#chart3-${region}`).getContext('2d');
    window.myCharts.chart3 = new Chart(chart3Ctx, {
        type: 'line', data: { labels, datasets: [ { label: 'End Balance', data: results.map(r => r.endBalance), yAxisID: 'yBalance', borderColor: 'rgb(75, 192, 192)' }, { label: 'Start Balance', data: results.map(r => r.startBalance), yAxisID: 'yBalance', borderColor: 'rgba(75, 192, 192, 0.2)' }, { label: 'Gains', data: results.map(r => r.gains), yAxisID: 'yGains', borderColor: 'rgb(153, 102, 255)' } ] },
        options: { plugins: { title: { display: true, text: 'Portfolio Growth Engine' } }, scales: { x: { title: { display: true, text: 'Age' } }, yBalance: { type: 'linear', position: 'left', title: { display: true, text: `Balance (${currency})` } }, yGains: { type: 'linear', position: 'right', title: { display: true, text: `Gains (${currency})` }, grid: { drawOnChartArea: false } } } }
    });

    const chart4Ctx = $(`#chart4-${region}`).getContext('2d');
    window.myCharts.chart4 = new Chart(chart4Ctx, {
        type: 'line', data: { labels, datasets: [ { label: 'Pre-Tax', data: results.map(r => r.preTaxBalance), fill: true, backgroundColor: 'rgba(255, 159, 64, 0.5)', borderColor: 'rgb(255, 159, 64)' }, { label: 'Post-Tax', data: results.map(r => r.postTaxBalance), fill: true, backgroundColor: 'rgba(54, 162, 235, 0.5)', borderColor: 'rgb(54, 162, 235)' } ] },
        options: { plugins: { title: { display: true, text: 'Portfolio Composition' } }, scales: { x: { title: { display: true, text: 'Age' } }, y: { stacked: true } } }
    });
  }

  function renderRecommendations(results, region) {
      const recommendationBlock = $(`#recommendations-block-${region}`);
      recommendationBlock.innerHTML = '';
      const shortfallYear = results.find(r => r.endBalance <= 0);
      if (shortfallYear) {
          recommendationBlock.innerHTML = `
            <div class="recommendations-block">
                <h3><i class="fa-solid fa-triangle-exclamation"></i> Action Recommended</h3>
                <p>Your projection shows your funds may run out at age <strong>${shortfallYear.age}</strong>. Here are some strategies to consider:</p>
                <ul>
                    <li><strong>Reduce Expenses:</strong> Lowering your planned expenses directly reduces how much you need to withdraw, making your money last significantly longer.</li>
                    <li><strong>Delay Retirement:</strong> Working a few more years can have a powerful dual effect: it allows your investments more time to grow and reduces the number of retirement years you need to fund.</li>
                    <li><strong>Increase Retirement Income:</strong> Consider if you can generate more guaranteed income in retirement, such as through part-time work or an annuity.</li>
                    <li><strong>Re-evaluate Withdrawal Strategy:</strong> The order you withdraw from pre-tax and post-tax accounts impacts your tax bill. Use the "Compare Strategies" button to see if another approach is more tax-efficient for you.</li>
                </ul>
            </div>`;
      }
  }

  window.openCompare = function (region) {
    const baseInputs = getInputs(region);
    baseInputs.region = region;
    const strategies = ['proportional', 'sequential', 'roth', 'custom'];
    const comparisonResults = [];

    strategies.forEach(strategy => {
        let tempInputs = {...baseInputs};
        tempInputs.withdrawalStrategy = strategy;
        
        const results = runSingleSimulation(tempInputs);
        
        const totalTaxesPaid = results.reduce((sum, r) => sum + r.taxesPaid, 0);
        const finalBalance = results.length > 0 ? results[results.length - 1].endBalance : 0;
        const shortfallYear = results.find(r => r.endBalance <= 0);
        const portfolioLifespan = shortfallYear ? shortfallYear.age : baseInputs.retirementAge + baseInputs.retirementYears;

        comparisonResults.push({ strategy, totalTaxesPaid, finalBalance, portfolioLifespan });
    });
    
    renderCompareTable(comparisonResults, region);
  };

  function renderCompareTable(data, region) {
      const compareBlock = $(`#compare-block-${region}`);
      compareBlock.classList.remove('hidden');
      const currency = region === 'us' ? '$' : 'â‚¹';

      const maxLifespan = Math.max(...data.map(d => d.portfolioLifespan));
      const maxBalance = Math.max(...data.map(d => d.finalBalance));
      const minTaxes = Math.min(...data.map(d => d.totalTaxesPaid));
      
      let html = `<h3>Strategy Comparison</h3>
        <p style="font-size:0.9em; color:#555;">Highlights the best outcome for each metric. Roth conversion is assumed at 5% of pre-tax balance/year; Custom is a 50/50 split.</p>
        <table class="expense-table compare-table">
            <thead>
                <tr>
                    <th>Strategy</th>
                    <th>Portfolio Lasts Until Age</th>
                    <th>Final Balance</th>
                    <th>Total Taxes Paid</th>
                </tr>
            </thead>
            <tbody>`;

      data.forEach(d => {
          const lifespanClass = d.portfolioLifespan >= maxLifespan ? 'best-in-class' : '';
          const balanceClass = d.finalBalance >= maxBalance && d.finalBalance > 0 ? 'best-in-class' : '';
          const taxClass = d.totalTaxesPaid <= minTaxes ? 'best-in-class' : '';
          
          let strategyName = d.strategy.charAt(0).toUpperCase() + d.strategy.slice(1);
          if (d.strategy === 'sequential') strategyName = "Sequential (Post-tax first)";

          html += `<tr>
              <td>${strategyName}</td>
              <td class="${lifespanClass}">${d.portfolioLifespan}</td>
              <td class="${balanceClass}">${fmtNum(d.finalBalance, region)}</td>
              <td class="${taxClass}">${fmtNum(d.totalTaxesPaid, region)}</td>
          </tr>`;
      });

      html += `</tbody></table>`;
      compareBlock.innerHTML = html;
  }
  
  window.exportTable = function (region, format) {
    const table = $(`#amortization-table-${region}`);
    if (!table) {
        alert('Nothing to export yet. Run a calculation first.');
        return;
    }

    if (format === 'xlsx') {
        if (typeof XLSX === 'undefined') {
            alert('Excel export library (SheetJS) is not available. Please check your internet connection.');
            return;
        }
        const wb = XLSX.utils.table_to_book(table, { sheet: "Retirement Projection" });
        XLSX.writeFile(wb, `Retirement_Projection_${region}.xlsx`);
    } else if (format === 'csv') {
        let csv = [];
        const rows = table.querySelectorAll("tr");
        
        for (const row of rows) {
            const cols = row.querySelectorAll("td, th");
            const rowData = [];
            for (const col of cols) {
                rowData.push(`"${col.innerText.replace(/"/g, '""')}"`);
            }
            csv.push(rowData.join(","));
        }
        
        const blob = new Blob([csv.join("\n")], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", `retirement_projection_${region}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
  };
  
  window.clearInputs = function (region) {
    $(`#form-calculator-${region}`).reset();
    $(`#results-block-${region}`).innerHTML = '';
    $(`#compare-block-${region}`).innerHTML = '';
    $(`#compare-block-${region}`).classList.add('hidden');
    handleStrategyChange(region);
  };

  function num(v) { const n = parseFloat(v); return isFinite(n) ? n : 0; }
  function fmtNum(n, region) { 
      const symbol = region === 'us' ? '$' : 'â‚¹';
      return symbol + (Number(n) || 0).toLocaleString(undefined, { maximumFractionDigits: 0 });
  }
  function flash(el) {
    el.style.backgroundColor = '#fff3cd';
    setTimeout(() => { el.style.backgroundColor = '#f1f5f9'; }, 450);
  }

  function updateExpenseDerived(table, region) {
    let monthlyTotal = 0;
    $all('tbody tr', table)
      .filter(tr => tr.querySelector('input'))
      .forEach(tr => {
        const m = num(tr.querySelector('input')?.value);
        monthlyTotal += m;
        tr.querySelector('.yearly').textContent = fmtNum(m * 12, region);
    });
    $(`#${region}-total-monthly`).textContent = fmtNum(monthlyTotal, region);
    $(`#${region}-total-yearly`).textContent = fmtNum(monthlyTotal * 12, region);
  }

  document.addEventListener('DOMContentLoaded', () => {
    ['us', 'india'].forEach(region => {
        handleStrategyChange(region);
        const table = $(`#monthly-expenses-${region}`);
        if (table) {
            updateExpenseDerived(table, region);
            table.addEventListener('input', () => updateExpenseDerived(table, region));
        }
    });
  });
})();
</script>
</body>
</html>
